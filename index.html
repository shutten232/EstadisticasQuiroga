<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Quiroga CRPC – Presentación + Impacto diario</title>

  <!-- Chart.js para los gráficos de la presentación -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#f4f5f7;
      --card-bg:#ffffff;
      --border:#d1d5db;
      --text-main:#111827;
      --text-muted:#6b7280;
      --brand-red:#b71c1c;
      --ok:#16a34a;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
    }

    html{
      scroll-behavior:smooth;
    }

    body{
      background:var(--bg);
      color:var(--text-main);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    /* Top bar OSCURA y clara de leer */
    .top-nav{
      position:sticky;
      top:0;
      z-index:20;
      background:#111827;
      backdrop-filter:blur(6px);
      border-bottom:1px solid #020617;
    }
    .top-nav-inner{
      max-width:1200px;
      margin:0 auto;
      padding:8px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      width:34px;
      height:34px;
      border-radius:999px;
      background:var(--brand-red);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#ffeb3b;
      font-weight:900;
      font-size:22px;
      box-shadow:0 4px 10px rgba(0,0,0,0.6);
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .brand-title{
      font-size:15px;
      font-weight:700;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#f9fafb;
    }
    .brand-sub{
      font-size:11px;
      color:#9ca3af;
      text-transform:uppercase;
      letter-spacing:.14em;
    }

    .nav-links{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .nav-links a{
      text-decoration:none;
      font-size:14px;
      font-weight:600;
      color:#e5e7eb;
      background:rgba(15,23,42,0.9);
      padding:6px 12px;
      border-radius:999px;
      border:1px solid #4b5563;
    }
    .nav-links a:hover{
      background:var(--brand-red);
      border-color:var(--brand-red);
      color:#ffffff;
      box-shadow:0 0 0 1px rgba(248,250,252,0.2);
    }

    /* Layout principal */
    .page{
      max-width:1200px;
      margin:0 auto 40px;
      padding:20px 18px 40px;
    }

    /* HERO (Presentación ejecutiva) – blanco, limpio */
    .hero{
      position:relative;
      background:#ffffff;
      border-radius:24px;
      padding:24px 24px 26px;
      border:1px solid #e5e7eb;
      box-shadow:0 12px 30px rgba(15,23,42,0.20);
      overflow:hidden;
      margin-bottom:26px;
    }

    .hero-content{
      max-width:620px;
      position:relative;
      z-index:1;
    }
    .hero-badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--brand-red);
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      margin-bottom:6px;
      color:#fef2f2;
      background:var(--brand-red);
    }
    .hero-title{
      font-size:30px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.06em;
      margin-bottom:6px;
      color:#111827;
    }
    .hero-subtitle{
      font-size:16px;
      color:#374151;
      margin-bottom:10px;
    }
    .hero-bullets{
      font-size:14px;
      color:#111827;
      padding-left:18px;
    }
    .hero-bullets li{
      margin-bottom:4px;
    }

    .hero-watermark{
      position:absolute;
      right:-40px;
      bottom:-80px;
      width:280px;
      height:280px;
      border-radius:50%;
      border:10px solid rgba(183,28,28,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .hero-watermark span{
      font-size:220px;
      font-weight:900;
      color:rgba(183,28,28,0.04);
      transform:translateY(10px);
    }

    /* Secciones generales */
    section{
      margin-bottom:30px;
    }
    .section-header{
      margin-bottom:14px;
    }
    .section-title{
      font-size:22px;
      font-weight:800;
      margin-bottom:2px;
      color:#111827;
    }
    .section-subtitle{
      font-size:14px;
      color:var(--text-muted);
    }

    /* Grids y cards */
    .grid-3{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:16px;
    }
    .grid-2{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:18px;
    }
    @media(max-width:900px){
      .grid-2,.grid-3{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card-bg);
      border-radius:18px;
      padding:18px 20px;
      border:1px solid var(--border);
      box-shadow:0 6px 20px rgba(15,23,42,0.12);
    }
    .card-title{
      font-size:15px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--brand-red);
      margin-bottom:8px;
    }
    .card-value{
      font-size:34px;
      font-weight:800;
      margin-bottom:4px;
    }
    .card-value.ok{ color:var(--ok); }
    .card-label{
      font-size:14px;
      color:var(--text-muted);
      margin-bottom:6px;
    }
    .card-note{
      font-size:14px;
      color:var(--text-muted);
    }
    .arrow{
      font-size:28px;
      margin-right:6px;
      vertical-align:middle;
    }

    .chart-card{
      background:var(--card-bg);
      border-radius:18px;
      padding:16px 18px;
      border:1px solid var(--border);
      box-shadow:0 6px 18px rgba(15,23,42,0.10);
    }
    .chart-title{
      font-size:15px;
      font-weight:600;
      color:var(--brand-red);
      margin-bottom:2px;
    }
    .chart-subtitle{
      font-size:13px;
      color:var(--text-muted);
      margin-bottom:8px;
    }
    .chart-container{
      width:100%;
      height:300px;
    }
    canvas{
      width:100% !important;
      height:100% !important;
    }

    .key-list{
      font-size:14px;
      color:var(--text-muted);
      padding-left:18px;
    }
    .key-list li{
      margin-bottom:4px;
    }

    .mini-tag{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      color:var(--text-muted);
      margin-bottom:4px;
    }

    /* ==== PANEL DIARIO ONLINE ==== */

    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--text-muted);
      margin-bottom:6px;
      background:#ffffff;
    }

    .daily-layout{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:18px;
      margin-bottom:22px;
    }
    @media(max-width:900px){
      .daily-layout{
        grid-template-columns:1fr;
      }
    }

    .date-label{
      font-size:14px;
      color:#374151;
      margin-bottom:12px;
      font-weight:600;
    }

    /* RESUMEN DE HOY: más grande y contrastado */
    .card-resumen-hoy{
      border:2px solid #111827;
    }

    .kpi{
      padding:12px 14px;
      border-radius:14px;
      border:2px solid #111827;
      background:#ffffff;
    }
    .kpi-label{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.10em;
      color:#4b5563;
      margin-bottom:6px;
      font-weight:700;
    }
    .kpi-value{
      font-size:30px;
      font-weight:800;
      color:#111827;
    }
    .kpi-value.ok{
      color:#15803d;
    }
    .kpi-extra{
      font-size:13px;
      color:#6b7280;
      margin-top:4px;
    }

    .note{
      font-size:13px;
      color:var(--text-muted);
      margin-top:6px;
    }

    form{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    label{
      font-size:14px;
      color:var(--text-main);
      font-weight:500;
    }
    input[type="number"],
    input[type="date"]{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:14px;
    }
    input[type="number"]:focus,
    input[type="date"]:focus{
      outline:none;
      border-color:var(--brand-red);
      box-shadow:0 0 0 1px rgba(183,28,28,0.25);
    }

    .btn{
      margin-top:6px;
      padding:9px 12px;
      border-radius:8px;
      border:1px solid var(--brand-red);
      background:var(--brand-red);
      color:#fff;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .btn:hover{
      background:#7f1d1d;
      border-color:#7f1d1d;
    }

    .btn-secondary{
      border-color:#9ca3af;
      background:#e5e7eb;
      color:#111827;
    }
    .btn-secondary:hover{
      background:#d1d5db;
      border-color:#6b7280;
    }

    .small-muted{
      font-size:12px;
      color:var(--text-muted);
      margin-top:6px;
    }

    .hist-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .hist-header-title{
      font-size:14px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--brand-red);
    }
    .hist-desc{
      font-size:12px;
      color:var(--text-muted);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid #e5e7eb;
      padding:6px 6px;
      text-align:left;
    }
    th{
      background:#f3f4f6;
      font-weight:600;
    }
    td.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    tr:nth-child(even) td{
      background:#fafafa;
    }
    .empty-row td{
      text-align:center;
      font-size:12px;
      color:var(--text-muted);
    }

    .chk-center{
      text-align:center;
    }
  </style>
</head>
<body>

  <!-- Barra superior -->
  <div class="top-nav">
    <div class="top-nav-inner">
      <div class="brand">
        <div class="brand-logo">Q</div>
        <div class="brand-text">
          <div class="brand-title">QUIROGA GNC</div>
          <div class="brand-sub">CRPC · ESTADÍSTICAS 2025</div>
        </div>
      </div>
      <nav class="nav-links">
        <a href="#presentacion">Presentación</a>
        <a href="#hoy">Hoy</a>
        <a href="#resumen">Resumen</a>
        <a href="#cantidades">Cantidades</a>
        <a href="#impacto">Impacto</a>
        <a href="#talleres">Talleres</a>
      </nav>
    </div>
  </div>

  <main class="page">

    <!-- ===== 0. PRESENTACIÓN EJECUTIVA (PRIMERO) ===== -->
    <section class="hero" id="presentacion">
      <div class="hero-content">
        <div class="hero-badge">Presentación ejecutiva</div>
        <h1 class="hero-title">CRPC & Obleas · Córdoba 2025</h1>
        <p class="hero-subtitle">
          Situación del año en una sola vista: cuánto procesamos, qué peso tenemos en Córdoba
          y quiénes son los talleres que más nos empujan.
        </p>
        <ul class="hero-bullets">
          <li><strong>8.300 cilindros</strong> procesados en el CRPC (10 meses).</li>
          <li>Participación promedio: <strong>16 %</strong> de los cilindros y <strong>11 %</strong> de las obleas de Córdoba.</li>
          <li>Meses pico claros y concentración en pocos talleres.</li>
        </ul>
      </div>
      <div class="hero-watermark">
        <span>Q</span>
      </div>
    </section>

    <!-- ===== 1. PANEL DIARIO ONLINE ===== -->
    <section id="hoy">
      <header class="section-header">
        <div class="badge">Impacto diario online</div>
        <h2 class="section-title">Quiroga CRPC vs Córdoba – Hoy</h2>
        <p class="section-subtitle">
          Cargás los cilindros de Córdoba y del CRPC del día. Se guarda en Firebase y todos
          los que abran esta página ven lo mismo, con historial y borrado.
        </p>
      </header>

      <div class="daily-layout">
        <!-- Panel de resultados -->
        <section class="card card-resumen-hoy">
          <div class="card-title">Resumen de hoy</div>
          <div class="date-label" id="lblFecha"></div>

          <div class="grid-3">
            <div class="kpi">
              <div class="kpi-label">Córdoba hoy</div>
              <div class="kpi-value" id="kpiCordoba">0</div>
              <div class="kpi-extra">Cilindros hechos en Córdoba.</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Quiroga CRPC hoy</div>
              <div class="kpi-value" id="kpiQuiroga">0</div>
              <div class="kpi-extra">Cilindros procesados en el CRPC.</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">Impacto hoy</div>
              <div class="kpi-value ok" id="kpiImpacto">0%</div>
              <div class="kpi-extra">Porcentaje de Córdoba que pasa por el CRPC.</div>
            </div>
          </div>

          <p class="note">
            Fórmula: <strong>Impacto = (Quiroga / Córdoba) × 100</strong>.  
            Si Córdoba es 0, se muestra “–”.
          </p>
        </section>

        <!-- Formulario -->
        <section class="card">
          <div class="card-title">Cargar datos del día</div>
          <p class="date-label" id="lblFechaForm"></p>

          <form id="formImpacto">
            <div>
              <label for="inpFecha">Fecha de los datos</label>
              <input type="date" id="inpFecha">
            </div>

            <div>
              <label for="inpCordoba">Cilindros hechos en Córdoba</label>
              <input type="number" id="inpCordoba" min="0" step="1" placeholder="Ej: 200">
            </div>

            <div>
              <label for="inpQuiroga">Cilindros hechos en Quiroga CRPC</label>
              <input type="number" id="inpQuiroga" min="0" step="1" placeholder="Ej: 70">
            </div>

            <button class="btn" type="submit">Guardar / agregar día</button>

            <div class="small-muted">
              Podés cambiar la fecha antes de guardar.  
              Si te equivocás, borrás la fila y la volvés a cargar con la fecha correcta.
            </div>
          </form>
        </section>
      </div>

      <!-- Historial -->
      <section class="card">
        <div class="hist-header">
          <div>
            <div class="hist-header-title">Historial de días guardados (online)</div>
            <div class="hist-desc">
              Datos guardados en Firestore (Firebase).  
              Se muestra un registro por guardado (podés tener varios del mismo día).
            </div>
          </div>
          <div>
            <button type="button" class="btn btn-secondary" id="btnBorrarSeleccionados">
              Borrar seleccionados
            </button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th class="num">Córdoba</th>
              <th class="num">Quiroga</th>
              <th class="num">Impacto %</th>
              <th class="chk-center">Sel.</th>
            </tr>
          </thead>
          <tbody id="tbodyHistorial">
            <!-- Filas generadas por JS -->
          </tbody>
        </table>
      </section>
    </section>

    <!-- ===== 2. RESUMEN ANUAL ===== -->
    <section id="resumen">
      <header class="section-header">
        <h2 class="section-title">1. Resumen anual</h2>
        <p class="section-subtitle">
          Totales del año y lectura rápida para que quede claro en 10 segundos.
        </p>
      </header>

      <div class="grid-3" style="margin-bottom:16px;">
        <article class="card">
          <div class="card-title">CRPC – cilindros 2025</div>
          <div class="card-value">8.300</div>
          <div class="card-label">Cilindros procesados en 10 meses.</div>
          <div class="card-note">
            Volumen suficiente para mostrar que el CRPC de Quiroga es
            un jugador fuerte dentro de la provincia.
          </div>
        </article>
        <article class="card">
          <div class="card-title">Obleas Quirgroup</div>
          <div class="card-value">3.920</div>
          <div class="card-label">Obleas emitidas por Quirgroup en el año.</div>
          <div class="card-note">
            Flujo constante de obleas, acompañando el movimiento de cilindros.
          </div>
        </article>
        <article class="card">
          <div class="card-title">Obleas Quiroga</div>
          <div class="card-value">18.672</div>
          <div class="card-label">Obleas emitidas por Quiroga en el año.</div>
          <div class="card-note">
            La base fuerte de obleas está concentrada en Quiroga taller.
          </div>
        </article>
      </div>

      <div class="grid-3">
        <article class="card">
          <div class="card-title">CRPC 2025 vs 2024</div>
          <div class="card-value ok">
            <span class="arrow">▲</span>+18%
          </div>
          <div class="card-label">Cilindros totales procesados.</div>
          <div class="card-note">
            2025 supera a 2024. Mensaje simple: <strong>este año se trabajó más.</strong>
          </div>
        </article>
        <article class="card">
          <div class="card-title">Impacto CRPC en Córdoba</div>
          <div class="card-value">16%</div>
          <div class="card-label">Participación promedio del año.</div>
          <div class="card-note">
            De cada 100 cilindros de Córdoba, <strong>16 pasan por nuestro CRPC.</strong>
          </div>
        </article>
        <article class="card">
          <div class="card-title">Impacto obleas del taller</div>
          <div class="card-value">11%</div>
          <div class="card-label">Quiroga + Quirgroup.</div>
          <div class="card-note">
            De cada 100 obleas de la provincia, unas <strong>11 salen del taller.</strong>
          </div>
        </article>
      </div>
    </section>

    <!-- ===== 3. CANTIDADES MENSUALES ===== -->
    <section id="cantidades">
      <header class="section-header">
        <h2 class="section-title">2. Cantidades mensuales</h2>
        <p class="section-subtitle">
          Barras simples, un gráfico para cilindros y otro para obleas, con el número escrito encima.
        </p>
      </header>

      <div class="grid-2">
        <article class="chart-card">
          <div class="chart-title">CRPC por mes</div>
          <div class="chart-subtitle">Cilindros procesados en el CRPC.</div>
          <div class="chart-container">
            <canvas id="chartCrpcMes"></canvas>
          </div>
        </article>

        <article class="chart-card">
          <div class="chart-title">Obleas por mes</div>
          <div class="chart-subtitle">Obleas totales del taller (Quiroga + Quirgroup).</div>
          <div class="chart-container">
            <canvas id="chartObleasMes"></canvas>
          </div>
        </article>
      </div>

      <article class="card" style="margin-top:16px;">
        <div class="card-title">Lectura rápida</div>
        <ul class="key-list">
          <li><strong>Picos de CRPC:</strong> Julio (1.027) y Octubre (1.099).</li>
          <li><strong>Mes más bajo CRPC:</strong> Marzo (557 cilindros).</li>
          <li>Las obleas acompañan bastante bien los picos de CRPC, sin meses “muertos”.</li>
        </ul>
      </article>
    </section>

    <!-- ===== 4. IMPACTO MENSUAL ===== -->
    <section id="impacto">
      <header class="section-header">
        <h2 class="section-title">3. Impacto mensual en Córdoba</h2>
        <p class="section-subtitle">
          Qué porcentaje representamos del total de la provincia, mes a mes.
        </p>
      </header>

      <div class="grid-2">
        <article class="chart-card">
          <div class="chart-title">Impacto CRPC (%)</div>
          <div class="chart-subtitle">
            Porcentaje de cilindros de Quiroga sobre el total de cilindros de Córdoba.
          </div>
          <div class="chart-container">
            <canvas id="chartImpactCrpc"></canvas>
          </div>
        </article>

        <article class="chart-card">
          <div class="chart-title">Impacto obleas (%)</div>
          <div class="chart-subtitle">
            Porcentaje de obleas del taller sobre el total de obleas de Córdoba.
          </div>
          <div class="chart-container">
            <canvas id="chartImpactObleas"></canvas>
          </div>
        </article>
      </div>

      <article class="card" style="margin-top:16px;">
        <div class="card-title">Lectura rápida</div>
        <ul class="key-list">
          <li>El CRPC se mueve casi siempre entre <strong>15 % y 16 %</strong>, con un máximo del 18 % en octubre.</li>
          <li>Las obleas se mantienen entre <strong>10 % y 12 %</strong>, sin caídas bruscas.</li>
          <li>Mensaje para el jefe: <strong>somos una parte estable del mercado de Córdoba, no algo marginal.</strong></li>
        </ul>
      </article>
    </section>

    <!-- ===== 5. TALLERES ===== -->
    <section id="talleres">
      <header class="section-header">
        <h2 class="section-title">4. Talleres que más aportan</h2>
        <p class="section-subtitle">
          Ranking simple de talleres por cilindros enviados al CRPC (ejemplo con 10 principales).
        </p>
      </header>

      <div class="grid-2">
        <article class="chart-card">
          <div class="chart-title">Top talleres por cilindros CRPC</div>
          <div class="chart-subtitle">
            Barras horizontales, nombre grande y número escrito a la derecha.
          </div>
          <div class="chart-container">
            <canvas id="chartTalleres"></canvas>
          </div>
        </article>

        <article class="card">
          <div class="mini-tag">Conclusiones</div>
          <div class="card-title" style="margin-top:4px;">Concentración de volumen</div>
          <ul class="key-list">
            <li>Los 3 primeros talleres explican una parte importante del volumen total del CRPC.</li>
            <li>Permite decidir dónde cuidar la relación comercial y dónde hay espacio para crecer.</li>
            <li>En una versión real se pueden listar todos los talleres, no solo el Top 10.</li>
          </ul>
        </article>
      </div>
    </section>

  </main>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // ===== CONFIGURACIÓN REAL DE TU PROYECTO FIREBASE =====
    const firebaseConfig = {
      apiKey: "AIzaSyAq1_VIg5BtPH9QPS5NwuJDrVCqyfQ3qwU",
      authDomain: "estadisticas-diarias.firebaseapp.com",
      databaseURL: "https://estadisticas-diarias-default-rtdb.firebaseio.com",
      projectId: "estadisticas-diarias",
      storageBucket: "estadisticas-diarias.firebasestorage.app",
      messagingSenderId: "952047688138",
      appId: "1:952047688138:web:5e01162214f6ee7bd71733",
      measurementId: "G-BD9QD9241G"
    };

    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
    var COLLECTION_NAME = "impacto_diario";

    var registros = [];

    function getHoyISO(){
      var hoy = new Date();
      return hoy.toISOString().slice(0,10); // AAAA-MM-DD
    }

    function formatFechaISO(fechaISO){
      var partes = fechaISO.split("-");
      if(partes.length !== 3) return fechaISO;
      var y = partes[0], m = partes[1], d = partes[2];
      return d + "/" + m + "/" + y;
    }

    function calcularImpacto(cordoba, quiroga){
      if(cordoba <= 0) return null;
      return (quiroga / cordoba) * 100;
    }

    function cargarRegistros(){
      db.collection(COLLECTION_NAME)
        .orderBy("fecha", "desc")
        .orderBy("createdAt", "desc")
        .get()
        .then(function(snapshot){
          registros = [];
          snapshot.forEach(function(doc){
            var data = doc.data();
            registros.push({
              docId: doc.id,
              fecha: data.fecha,
              cordoba: data.cordoba || 0,
              quiroga: data.quiroga || 0,
              createdAt: data.createdAt || null
            });
          });
          renderTodo();
        })
        .catch(function(err){
          console.error("Error al leer Firestore", err);
        });
    }

    function obtenerResumenHoy(){
      var hoyISO = getHoyISO();
      for(var i = 0; i < registros.length; i++){
        if(registros[i].fecha === hoyISO){
          return registros[i];
        }
      }
      return null;
    }

    function renderResumen(){
      var lblFecha = document.getElementById("lblFecha");
      var lblFechaForm = document.getElementById("lblFechaForm");
      var kpiCordoba = document.getElementById("kpiCordoba");
      var kpiQuiroga = document.getElementById("kpiQuiroga");
      var kpiImpacto = document.getElementById("kpiImpacto");
      var inpCordoba = document.getElementById("inpCordoba");
      var inpQuiroga = document.getElementById("inpQuiroga");
      var inpFecha = document.getElementById("inpFecha");

      var hoyISO = getHoyISO();
      var fechaTextoHoy = formatFechaISO(hoyISO);
      var resumen = obtenerResumenHoy();

      var cordoba = 0;
      var quiroga = 0;

      if(resumen){
        cordoba = resumen.cordoba || 0;
        quiroga = resumen.quiroga || 0;
      }

      // Resumen siempre habla de HOY
      lblFecha.textContent = "Datos del día de hoy: " + fechaTextoHoy;

      // Texto del formulario (la fecha la elige el usuario)
      lblFechaForm.textContent = "Seleccioná la fecha de los datos (por defecto hoy).";

      // Por defecto, el input de fecha arranca en hoy si está vacío
      if(!inpFecha.value){
        inpFecha.value = hoyISO;
      }

      kpiCordoba.textContent = cordoba;
      kpiQuiroga.textContent = quiroga;

      var impacto = calcularImpacto(cordoba, quiroga);
      if(impacto === null){
        kpiImpacto.textContent = "–";
      }else{
        kpiImpacto.textContent = impacto.toFixed(1).replace(".",",") + "%";
      }

      // No autocompleto los inputs numéricos con hoy, los dejos vacíos
      inpCordoba.value = "";
      inpQuiroga.value = "";
    }

    function renderTabla(){
      var tbody = document.getElementById("tbodyHistorial");
      tbody.innerHTML = "";

      if(registros.length === 0){
        var trVacio = document.createElement("tr");
        trVacio.classList.add("empty-row");
        var tdVacio = document.createElement("td");
        tdVacio.colSpan = 5;
        tdVacio.textContent = "Sin registros guardados.";
        trVacio.appendChild(tdVacio);
        tbody.appendChild(trVacio);
        return;
      }

      var ordenados = registros.slice();

      ordenados.forEach(function(reg){
        var tr = document.createElement("tr");

        var tdFecha = document.createElement("td");
        tdFecha.textContent = formatFechaISO(reg.fecha);
        tr.appendChild(tdFecha);

        var tdCordoba = document.createElement("td");
        tdCordoba.classList.add("num");
        tdCordoba.textContent = reg.cordoba || 0;
        tr.appendChild(tdCordoba);

        var tdQuiroga = document.createElement("td");
        tdQuiroga.classList.add("num");
        tdQuiroga.textContent = reg.quiroga || 0;
        tr.appendChild(tdQuiroga);

        var tdImpacto = document.createElement("td");
        tdImpacto.classList.add("num");
        var imp = calcularImpacto(reg.cordoba, reg.quiroga);
        tdImpacto.textContent = (imp === null)
          ? "–"
          : imp.toFixed(1).replace(".",",") + "%";
        tr.appendChild(tdImpacto);

        var tdSel = document.createElement("td");
        tdSel.classList.add("chk-center");
        var chk = document.createElement("input");
        chk.type = "checkbox";
        chk.classList.add("fila-check");
        chk.dataset.id = reg.docId;
        tdSel.appendChild(chk);
        tr.appendChild(tdSel);

        tbody.appendChild(tr);
      });
    }

    function renderTodo(){
      renderResumen();
      renderTabla();
    }

    document.getElementById("formImpacto").addEventListener("submit", function(e){
      e.preventDefault();

      var inpCordoba = document.getElementById("inpCordoba");
      var inpQuiroga = document.getElementById("inpQuiroga");
      var inpFecha = document.getElementById("inpFecha");

      var cordoba = parseInt(inpCordoba.value, 10) || 0;
      var quiroga = parseInt(inpQuiroga.value, 10) || 0;
      var fecha = inpFecha.value || getHoyISO(); // fecha elegida o hoy por defecto

      db.collection(COLLECTION_NAME).add({
        fecha: fecha,
        cordoba: cordoba,
        quiroga: quiroga,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(function(){
        // Limpio inputs numéricos, dejo la fecha como está
        inpCordoba.value = "";
        inpQuiroga.value = "";
        cargarRegistros();
      })
      .catch(function(err){
        console.error("Error al guardar en Firestore", err);
      });
    });

    document.getElementById("btnBorrarSeleccionados").addEventListener("click", function(){
      var checks = document.querySelectorAll(".fila-check:checked");
      if(checks.length === 0){
        return;
      }

      var ids = Array.prototype.map.call(checks, function(chk){
        return chk.dataset.id;
      });

      var batch = db.batch();
      ids.forEach(function(id){
        var ref = db.collection(COLLECTION_NAME).doc(id);
        batch.delete(ref);
      });

      batch.commit()
        .then(function(){
          cargarRegistros();
        })
        .catch(function(err){
          console.error("Error borrando registros", err);
        });
    });

    // Inicio panel diario
    cargarRegistros();
  </script>

  <script>
    // ===== DATOS PRESENTACIÓN 2025 (Chart.js) =====
    const labelsMeses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct'];

    const dataCRPC  = [947, 655, 557, 692, 660, 777, 1027, 931, 955, 1099];
    const dataObleasTotales = [2586,1571,1926,2179,2049,2096,2600,2535,2505,2545];

    const impactoCRPC   = [16,14,13,15,16,16,15,16,16,18];
    const impactoObleas = [13,10,11,11,11,11,12,12,12,12];

    const labelsTalleres = [
      'Minuto GNC',
      'Zico',
      'Colón GNC',
      'Tabach',
      'Franco Alta Gracia',
      'Calera Torres',
      'Silvana Calera',
      'Córdoba GNC',
      'Brochero',
      'Valparaíso'
    ];
    const dataTalleres = [950, 880, 760, 640, 590, 540, 480, 430, 400, 360];

    // Plugin: escribe números negros encima de las barras.
    // Para los gráficos de impacto, agrega el %.
    const valueLabelsPlugin = {
      id: 'valueLabels',
      afterDatasetsDraw(chart, args, pluginOptions) {
        const {ctx} = chart;
        const isImpactChart =
          chart.canvas &&
          (chart.canvas.id === 'chartImpactCrpc' ||
           chart.canvas.id === 'chartImpactObleas');

        chart.data.datasets.forEach((dataset, datasetIndex) => {
          const meta = chart.getDatasetMeta(datasetIndex);
          if (meta.hidden) return;
          meta.data.forEach((el, index) => {
            const value = dataset.data[index];
            if (value == null) return;

            const text = isImpactChart ? value + '%' : value;

            ctx.save();
            ctx.fillStyle = '#111827';
            ctx.font = 'bold 12px system-ui';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';

            if (chart.options.indexAxis === 'y') {
              const x = el.x + 8;
              const y = el.y + 4;
              ctx.textAlign = 'left';
              ctx.textBaseline = 'middle';
              ctx.fillText(text, x, y);
            } else {
              const x = el.x;
              const y = el.y - 3;
              ctx.fillText(text, x, y);
            }
            ctx.restore();
          });
        });
      }
    };

    new Chart(document.getElementById('chartCrpcMes'), {
      type:'bar',
      data:{
        labels:labelsMeses,
        datasets:[{
          label:'CRPC',
          data:dataCRPC,
          backgroundColor:'rgba(17,24,39,0.9)',
          borderRadius:8,
          barThickness:26,
          maxBarThickness:32
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{ label:ctx=>` ${ctx.parsed.y} cilindros` }
          }
        },
        scales:{
          x:{
            grid:{ display:false },
            ticks:{ font:{ size:13, weight:'600' } }
          },
          y:{
            beginAtZero:true,
            grid:{ color:'rgba(148,163,184,0.3)' },
            ticks:{ font:{ size:11 } }
          }
        }
      },
      plugins:[valueLabelsPlugin]
    });

    new Chart(document.getElementById('chartObleasMes'), {
      type:'bar',
      data:{
        labels:labelsMeses,
        datasets:[{
          label:'Obleas (Q+QG)',
          data:dataObleasTotales,
          backgroundColor:'rgba(183,28,28,0.9)',
          borderRadius:8,
          barThickness:26,
          maxBarThickness:32
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{ label:ctx=>` ${ctx.parsed.y} obleas` }
          }
        },
        scales:{
          x:{
            grid:{ display:false },
            ticks:{ font:{ size:13, weight:'600' } }
          },
          y:{
            beginAtZero:true,
            grid:{ color:'rgba(148,163,184,0.3)' },
            ticks:{ font:{ size:11 } }
          }
        }
      },
      plugins:[valueLabelsPlugin]
    });

    new Chart(document.getElementById('chartImpactCrpc'), {
      type:'bar',
      data:{
        labels:labelsMeses,
        datasets:[{
          label:'Impacto CRPC %',
          data:impactoCRPC,
          backgroundColor:'rgba(21,101,192,0.9)',
          borderRadius:8,
          barThickness:24,
          maxBarThickness:30
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{ label:ctx=>` ${ctx.parsed.y}%` }
          }
        },
        scales:{
          x:{
            grid:{ display:false },
            ticks:{ font:{ size:13, weight:'600' } }
          },
          y:{
            beginAtZero:true,
            max:20,
            grid:{ color:'rgba(148,163,184,0.3)' },
            ticks:{ font:{ size:11 } }
          }
        }
      },
      plugins:[valueLabelsPlugin]
    });

    new Chart(document.getElementById('chartImpactObleas'), {
      type:'bar',
      data:{
        labels:labelsMeses,
        datasets:[{
          label:'Impacto obleas %',
          data:impactoObleas,
          backgroundColor:'rgba(183,28,28,0.9)',
          borderRadius:8,
          barThickness:24,
          maxBarThickness:30
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{ label:ctx=>` ${ctx.parsed.y}%` }
          }
        },
        scales:{
          x:{
            grid:{ display:false },
            ticks:{ font:{ size:13, weight:'600' } }
          },
          y:{
            beginAtZero:true,
            max:20,
            grid:{ color:'rgba(148,163,184,0.3)' },
            ticks:{ font:{ size:11 } }
          }
        }
      },
      plugins:[valueLabelsPlugin]
    });

    new Chart(document.getElementById('chartTalleres'), {
      type:'bar',
      data:{
        labels:labelsTalleres,
        datasets:[{
          label:'Cilindros CRPC (año)',
          data:dataTalleres,
          backgroundColor:'rgba(17,24,39,0.9)',
          borderRadius:8,
          barThickness:22,
          maxBarThickness:28
        }]
      },
      options:{
        indexAxis:'y',
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{
            callbacks:{ label:ctx=>` ${ctx.parsed.x} cilindros` }
          }
        },
        scales:{
          x:{
            beginAtZero:true,
            grid:{ color:'rgba(148,163,184,0.3)' },
            ticks:{ font:{ size:12 } }
          },
          y:{
            grid:{ display:false },
            ticks:{ font:{ size:13, weight:'600' } }
          }
        }
      },
      plugins:[valueLabelsPlugin]
    });
  </script>

</body>
</html>
